<!-- Modal Backdrop -->
<div class="modal-backdrop" *ngIf="showModal" (click)="onClose()" [class.rtl]="isRTL" [class.ltr]="!isRTL">
  <div class="modal-content create-modal" (click)="$event.stopPropagation()">
    
    <!-- Modal Header -->
    <div class="modal-header" [class.rtl]="isRTL" [class.ltr]="!isRTL">
      <h4>{{ (editMode ? 'CREATE_REQUEST_APPROVAL_ROUTE.EDIT_TITLE' : 'CREATE_REQUEST_APPROVAL_ROUTE.TITLE') | translate }}</h4>
      <button class="close-btn" (click)="onClose()" type="button" [attr.aria-label]="'CREATE_REQUEST_APPROVAL_ROUTE.CLOSE' | translate">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Loading Edit Data -->
      <div *ngIf="loadingEditData" class="loading-spinner">
        <div class="spinner"></div>
        <p>{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DATA' | translate }}</p>
      </div>

      <form [formGroup]="createForm" (ngSubmit)="onSubmit()" *ngIf="!loadingEditData">
        
        <!-- Main Configuration Section -->
        <div class="form-section">
          <h5 class="section-title">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MAIN_CONFIGURATION' | translate }}</h5>
          
          <!-- For Everyone Radio Buttons -->
          <div class="form-group">
            <label class="form-label required">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.TARGET_AUDIENCE' | translate }}</label>
            <div class="radio-group">
              <div class="radio-option" *ngFor="let option of forEveryoneOptions">
                <input 
                  type="radio" 
                  [id]="'forEveryone_' + option.value" 
                  [value]="option.value" 
                  formControlName="forEveryone"
                  (change)="onForEveryoneChange()"
                  class="radio-input">
                <label [for]="'forEveryone_' + option.value" class="radio-label">
                  {{ option.label | translate }}
                </label>
              </div>
            </div>
            <div class="error-message" *ngIf="isFieldRequired('forEveryone')">
              {{ 'CREATE_REQUEST_APPROVAL_ROUTE.FIELD_REQUIRED' | translate }}
            </div>
          </div>

          <!-- Show form only for "For Everyone" option -->
          <div *ngIf="selectedForEveryone === 1">
            
            <!-- Status Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.STATUS' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="statusId" class="form-select" [class.error]="isFieldRequired('statusId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_STATUS' | translate }}</option>
                  <option *ngFor="let status of statuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingStatuses">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_STATUSES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('statusId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.STATUS_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Request Levels Dropdown -->
            <div class="form-group">
              <label class="form-label required">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.REQUEST_LEVELS' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="reqLevels" class="form-select" (change)="onRequestLevelsChange()" [class.error]="isFieldRequired('reqLevels')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_REQUEST_LEVELS' | translate }}</option>
                  <option *ngFor="let level of requestLevels" [value]="level.value">
                    {{ level.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingRequestLevels">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_REQUEST_LEVELS' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('reqLevels')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.REQUEST_LEVELS_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Note Input -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.NOTE' | translate }}</label>
              <textarea 
                formControlName="note" 
                class="form-textarea" 
                rows="3" 
                [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.NOTE_PLACEHOLDER' | translate"
                [class.error]="isFieldRequired('note')">
              </textarea>
              <div class="error-message" *ngIf="isFieldRequired('note')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.NOTE_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Dynamic Level Details -->
            <div class="levels-container" formArrayName="levelDetails">
              <div 
                *ngFor="let levelControl of levelDetailsArray.controls; let i = index" 
                class="level-section"
                [formGroupName]="i">
                
                <h5 class="level-title">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }} {{ i + 1 }}</h5>
                
                <!-- Dynamic Direct Manager -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_DIRECT_MANAGER' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynDirectMgr_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynDirectMgr"
                          class="radio-input">
                        <label [for]="'dynDirectMgr_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Direct Manager Details -->
                  <div class="dynamic-details" *ngIf="isDynDirectMgrSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynDirectMgrDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynDirectMgrAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynDirectMgrLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dynamic Manager of Department -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_MANAGER_DEPARTMENT' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynMgrOfDept_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynMgrOfDept"
                          class="radio-input">
                        <label [for]="'dynMgrOfDept_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Manager of Department Details -->
                  <div class="dynamic-details" *ngIf="isDynMgrOfDeptSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynMgrOfDeptDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfDeptAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfDeptLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dynamic Manager of Branch -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_MANAGER_BRANCH' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynMgrOfBranch_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynMgrOfBranch"
                          class="radio-input">
                        <label [for]="'dynMgrOfBranch_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Manager of Branch Details -->
                  <div class="dynamic-details" *ngIf="isDynMgrOfBranchSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynMgrOfBranchDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfBranchAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfBranchLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Static Dropdowns Section -->
                <div class="form-subsection">
                  <h6 class="subsection-title">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.ASSIGNMENTS' | translate }}</h6>
                  
                  <div class="form-row">
                    <!-- Manager -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER' | translate }}</option>
                          <option *ngFor="let manager of managers" [value]="manager.value">
                            {{ manager.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_MANAGERS' | translate }}</div>
                    </div>

                    <!-- Manager of Department -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_DEPARTMENT' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrOfDeptId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_DEPARTMENT' | translate }}</option>
                          <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                            {{ dept.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
                    </div>

                    <!-- Manager of Branch -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_BRANCH' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrOfBranchId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_BRANCH' | translate }}</option>
                          <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                            {{ branch.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
                    </div>
                  </div>

                  <div class="form-row">
                    <!-- Department -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DEPARTMENT' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="deptId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_DEPARTMENT' | translate }}</option>
                          <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                            {{ dept.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
                    </div>

                    <!-- Branch -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.BRANCH' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="branchId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_BRANCH' | translate }}</option>
                          <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                            {{ branch.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
                    </div>

                    <!-- Role -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.ROLE' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="roleId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ROLE' | translate }}</option>
                          <option *ngFor="let role of roles" [value]="role.value">
                            {{ role.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingRoles">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_ROLES' | translate }}</div>
                    </div>
                  </div>

                  <!-- Note Details -->
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL_NOTE' | translate }}</label>
                    <textarea 
                      formControlName="noteDetails" 
                      class="form-textarea" 
                      rows="2" 
                      [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL_NOTE_PLACEHOLDER' | translate">
                    </textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Form for "For a given group" option -->
          <div *ngIf="selectedForEveryone === 0">
            
            <!-- Employee Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.EMPLOYEE' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="empId" class="form-select" [class.error]="isFieldRequired('empId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_EMPLOYEE' | translate }}</option>
                  <option *ngFor="let employee of employees" [value]="employee.value">
                    {{ employee.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingEmployees">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_EMPLOYEES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('empId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.EMPLOYEE_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Manager of Department Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_DEPARTMENT' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="mgrOfDeptId" class="form-select" [class.error]="isFieldRequired('mgrOfDeptId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_DEPARTMENT' | translate }}</option>
                  <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                    {{ dept.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('mgrOfDeptId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_DEPARTMENT_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Manager of Branch Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_BRANCH' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="mgrOfBranchId" class="form-select" [class.error]="isFieldRequired('mgrOfBranchId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_BRANCH' | translate }}</option>
                  <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                    {{ branch.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('mgrOfBranchId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_BRANCH_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Department Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DEPARTMENT' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="deptId" class="form-select" [class.error]="isFieldRequired('deptId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_DEPARTMENT' | translate }}</option>
                  <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                    {{ dept.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('deptId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.DEPARTMENT_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Branch Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.BRANCH' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="branchId" class="form-select" [class.error]="isFieldRequired('branchId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_BRANCH' | translate }}</option>
                  <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                    {{ branch.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('branchId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.BRANCH_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Role Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.ROLE' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="roleId" class="form-select" [class.error]="isFieldRequired('roleId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ROLE' | translate }}</option>
                  <option *ngFor="let role of roles" [value]="role.value">
                    {{ role.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingRoles">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_ROLES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('roleId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.ROLE_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Status Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.STATUS' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="statusId" class="form-select" [class.error]="isFieldRequired('statusId')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_STATUS' | translate }}</option>
                  <option *ngFor="let status of statuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingStatuses">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_STATUSES' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('statusId')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.STATUS_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Request Levels Dropdown -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.REQUEST_LEVELS' | translate }}</label>
              <div class="dropdown-wrapper">
                <select formControlName="reqLevels" class="form-select" (change)="onRequestLevelsChange()" [class.error]="isFieldRequired('reqLevels')">
                  <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_REQUEST_LEVELS' | translate }}</option>
                  <option *ngFor="let level of requestLevels" [value]="level.value">
                    {{ level.label }}
                  </option>
                </select>
                <i class="fa fa-chevron-down dropdown-icon"></i>
              </div>
              <div class="loading-text" *ngIf="loadingRequestLevels">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_REQUEST_LEVELS' | translate }}</div>
              <div class="error-message" *ngIf="isFieldRequired('reqLevels')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.REQUEST_LEVELS_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Note Input -->
            <div class="form-group">
              <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.NOTE' | translate }}</label>
              <textarea 
                formControlName="note" 
                class="form-textarea" 
                rows="3" 
                [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.NOTE_PLACEHOLDER' | translate"
                [class.error]="isFieldRequired('note')">
              </textarea>
              <div class="error-message" *ngIf="isFieldRequired('note')">
                {{ 'CREATE_REQUEST_APPROVAL_ROUTE.NOTE_REQUIRED' | translate }}
              </div>
            </div>

            <!-- Dynamic Level Details for Group -->
            <div class="levels-container" formArrayName="levelDetails">
              <div 
                *ngFor="let levelControl of levelDetailsArray.controls; let i = index" 
                class="level-section"
                [formGroupName]="i">
                
                <h5 class="level-title">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }} {{ i + 1 }}</h5>
                
                <!-- Dynamic Direct Manager -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_DIRECT_MANAGER' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynDirectMgr_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynDirectMgr"
                          class="radio-input">
                        <label [for]="'dynDirectMgr_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Direct Manager Details -->
                  <div class="dynamic-details" *ngIf="isDynDirectMgrSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynDirectMgrDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynDirectMgrAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynDirectMgrLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dynamic Manager of Department -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_MANAGER_DEPARTMENT' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynMgrOfDept_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynMgrOfDept"
                          class="radio-input">
                        <label [for]="'dynMgrOfDept_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Manager of Department Details -->
                  <div class="dynamic-details" *ngIf="isDynMgrOfDeptSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynMgrOfDeptDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfDeptAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfDeptLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dynamic Manager of Branch -->
                <div class="form-subsection">
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DYNAMIC_MANAGER_BRANCH' | translate }}</label>
                    <div class="radio-group inline">
                      <div class="radio-option" *ngFor="let option of yesNoOptions">
                        <input 
                          type="radio" 
                          [id]="'dynMgrOfBranch_' + i + '_' + option.value" 
                          [value]="option.value" 
                          formControlName="dynMgrOfBranch"
                          class="radio-input">
                        <label [for]="'dynMgrOfBranch_' + i + '_' + option.value" class="radio-label">
                          {{ option.label | translate }}
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Dynamic Manager of Branch Details -->
                  <div class="dynamic-details" *ngIf="isDynMgrOfBranchSelected(i)">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS' | translate }}</label>
                        <input 
                          type="number" 
                          formControlName="dynMgrOfBranchDaysLimits" 
                          class="form-input"
                          [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.DAYS_LIMITS_PLACEHOLDER' | translate">
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.AFTER_LIMIT_ACTION' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfBranchAfterLimitAction" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ACTION' | translate }}</option>
                            <option *ngFor="let action of afterLimitActions" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL' | translate }}</label>
                        <div class="dropdown-wrapper">
                          <select formControlName="dynMgrOfBranchLevel" class="form-select">
                            <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_LEVEL' | translate }}</option>
                            <option *ngFor="let level of levels" [value]="level.value">
                              {{ level.label }}
                            </option>
                          </select>
                          <i class="fa fa-chevron-down dropdown-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Static Dropdowns Section -->
                <div class="form-subsection">
                  <h6 class="subsection-title">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.ASSIGNMENTS' | translate }}</h6>
                  
                  <div class="form-row">
                    <!-- Manager -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER' | translate }}</option>
                          <option *ngFor="let manager of managers" [value]="manager.value">
                            {{ manager.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_MANAGERS' | translate }}</div>
                    </div>

                    <!-- Manager of Department -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_DEPARTMENT' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrOfDeptId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_DEPARTMENT' | translate }}</option>
                          <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                            {{ dept.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
                    </div>

                    <!-- Manager of Branch -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.MANAGER_OF_BRANCH' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="mgrOfBranchId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_MANAGER_OF_BRANCH' | translate }}</option>
                          <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                            {{ branch.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
                    </div>
                  </div>

                  <div class="form-row">
                    <!-- Department -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.DEPARTMENT' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="deptId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_DEPARTMENT' | translate }}</option>
                          <option *ngFor="let dept of departmentsOrManagers" [value]="dept.value">
                            {{ dept.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingDepartmentsOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_DEPARTMENTS' | translate }}</div>
                    </div>

                    <!-- Branch -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.BRANCH' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="branchId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_BRANCH' | translate }}</option>
                          <option *ngFor="let branch of branchesOrManagers" [value]="branch.value">
                            {{ branch.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingBranchesOrManagers">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_BRANCHES' | translate }}</div>
                    </div>

                    <!-- Role -->
                    <div class="form-group">
                      <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.ROLE' | translate }}</label>
                      <div class="dropdown-wrapper">
                        <select formControlName="roleId" class="form-select">
                          <option value="">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.SELECT_ROLE' | translate }}</option>
                          <option *ngFor="let role of roles" [value]="role.value">
                            {{ role.label }}
                          </option>
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                      </div>
                      <div class="loading-text" *ngIf="loadingRoles">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LOADING_ROLES' | translate }}</div>
                    </div>
                  </div>

                  <!-- Note Details -->
                  <div class="form-group">
                    <label class="form-label">{{ 'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL_NOTE' | translate }}</label>
                    <textarea 
                      formControlName="noteDetails" 
                      class="form-textarea" 
                      rows="2" 
                      [placeholder]="'CREATE_REQUEST_APPROVAL_ROUTE.LEVEL_NOTE_PLACEHOLDER' | translate">
                    </textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="submitting">
        {{ 'CREATE_REQUEST_APPROVAL_ROUTE.CANCEL' | translate }}
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="onSubmit()" 
        [disabled]="submitting">
        <span *ngIf="submitting" class="spinner-sm"></span>
        <span *ngIf="!submitting">{{ (editMode ? 'CREATE_REQUEST_APPROVAL_ROUTE.UPDATE_ROUTE' : 'CREATE_REQUEST_APPROVAL_ROUTE.CREATE_ROUTE') | translate }}</span>
        <span *ngIf="submitting">{{ (editMode ? 'CREATE_REQUEST_APPROVAL_ROUTE.UPDATING' : 'CREATE_REQUEST_APPROVAL_ROUTE.CREATING') | translate }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Toast Messages -->
<p-toast position="top-right"></p-toast>

